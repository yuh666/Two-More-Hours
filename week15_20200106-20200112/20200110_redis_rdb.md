## rdb持久化

### rdb文件的创建与载入

1. save:主线程执行save操作刷新内存数据到dump.rdb文件  此时其他请求被拒绝
2. Bgsave:fork 子进程进行数据的拷贝(写时复制 copy and write)
3. redis启动时会检查是否开启aof,如果开启了aof则加载aof数据到内存中,如果未开启则加载rdb文件数据,载入成功之前服务器为阻塞状态
4. save bgsave bgrewriteaof不能同时执行rdbsave操作

### rdb保存时间间隔

```redis
save 900 1 		900秒之内1次修改
save 300 10		300秒之内至少10次修改
save 60 10000	60秒之内至少10000次修改	
```

1. 参数通过saveParam数组来记录,每个saveParm对象包含修改数changes和秒数second
2. redis服务器内部存储key被修改的次数和上一次执行保存操作的时间
   - dirty:修改计数器
   - lastsave:上一次保存的时间
3. 是否进行rdb的执行流程?
   - 周期性100ms执行一次serverCron()方法维护服务器的数据,满足则进行bgsave命令
   - 遍历saveParam[]数组
   - 计算currentTime-lastsave之间的时间差
   - 判断修改次数dirty>=changes && 时间差 > saveparm.seconds

### rdb文件存储结构

1. redis:5个字节代表redis
2. db_version:4个字节代表rdb文件的版本号
3. database:1个子节点代表当前数据库
4. eof:1个字节,代表rdb文件正文内容结束,即当进行rdb装载时此时结束
5. check_sum:8个字节,相当于文件的md5 保证dump.rdb文件的完整性
6. database数据部分的结构
   - selected:1个字节的常量 代表接下来要读取的为数据库dbIndex
   - db_number:读取那个db
   - key_value_pairs:db中的字典数据(如果有过期时间会1个字节+8个字节毫秒值),其他还是type key value,type确定了数据的类型string list hash set zset,key为字符串对象,值的编码方式通过value的encoding可知
7. 字符串类型value
   - int编码,比如int8位来保存整数
   - raw编码:小于20个字节时原样存储,len string
   - raw编码:大雨20个字节时进行压缩 压缩标识符 压缩后长度 压缩前长度 内容
8. 列表对象
   -  list_length:列表长度,元素的个数
   -  len string:每个元素的长度和值
9. 集合对象
   - set_size:集合长度
   - len string:集合元素的长度和值
10. 哈希表对象
    - hash_size:哈希表的大小
    - len keyString len valueString:key和value
11. 有序集合
    - sort_set_size:有序集合的容量
    - member score :值和分数字符串
12. intset(集合对象),ziplist(通过type类型转成对应的type,比如list ziplist,转成list_ziplist)

### 分析rdb文件

```redis
od -c dump.rdb
od -cx dump.rdb:同时打印ASCII和16进制的格式打印rdb文件
```