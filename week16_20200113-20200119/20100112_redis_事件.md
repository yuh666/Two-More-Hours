## 事件

1. 文件事件(file event):redis服务器通过套接字来与客户端或者其他服务器连接,文件事件即服务器对套接子的操作
2. 时间事件(time event):redis服务器中一些操作(比如serverCron函数,aof flush)在给定时间执行



## 文件事件

1. 文件事件处理器使用I/O多路复用(select/epoll)同时监听多个套接字,并根据套接字执行任务来关联对应的事件处理器
2. 文件事件处理器
   - 套接字:状态有连接应答 写入 读取 关闭等操作
   - io多路复用程序:负责监听套接字,一对多 所有事件的套接字放入一个队列中,这样能保证套接字事件的有序 同步,每次一个给文件事件分派器去执行
   - 文件事件分派器:根据套接字产生的事件类型调用相应的事件处理器
   - 事件处理器:根据套接字绑定的事件来调用对应的事件处理器执行
3. 事件的类型:
   - ae_readable事件,当客户端对套接字执行write或者close操作
   - ae_writeable事件,当客户端对套接字执行read操作
   - 文件事件分派器先执行ae_readable事件,即同一个套接字操作两种操作



## 文件事件处理器

1. 连接应答处理器:对连接服务器监听套接字的客户端进行应答
2. 命令请求处理器:为了接收客户端传来的命令请求,服务器为客户端套接字关联命令请求处理器
3. 命令恢复处理器:负责将服务器执行命令后的结果回复通过套接字来返回给客户端



## 时间事件

1. 定时事件:程序在指定时间执行一次(该事件返回ae.h/ae_nomore当时间到达执行后该事件删除)
2. 定期事件:每隔一段时间执行一次(该事件执行一次后会重置when的时间等待下一次执行)
   - 更新服务器的各类统计信息(比如内存占用 数据库占用情况)
   - 清理数据库中的过期键值对(即过期key的淘汰策略定期删除)
   - 关闭和清理连接失效的客户端(客户端对应的连接闲置多久后进行回收)
   - 尝试持久化(aof和rdb),rdb:save表达式 aof:100ms serverCorn函数
   - 如果当前服务器是主服务器,对从服务器的数据发送
   - 如果是集群模式,进行定期同步和连接测试
3. 时间包括三个属性:
   - id:时间事件唯一id
   - when:记录时间到什么时候执行
   - timeProc:时间时间函数,当时间到when的时候执行该函数
4. 服务器时间事件存储方式:无序的链表,每次时间时间处理器执行时,遍历整个链表