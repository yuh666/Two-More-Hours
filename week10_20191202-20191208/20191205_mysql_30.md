## 案例一

```sql
CREATE TABLE `t` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `c` int(11) DEFAULT NULL,
  `d` int(11) DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `c` (`c`)
) ENGINE=InnoDB AUTO_INCREMENT=32 DEFAULT CHARSET=utf8;

INSERT INTO `test`.`t`(`id`, `c`, `d`) VALUES (1, 0, 0);
INSERT INTO `test`.`t`(`id`, `c`, `d`) VALUES (5, 5, 5);
INSERT INTO `test`.`t`(`id`, `c`, `d`) VALUES (10, 10, 10);
INSERT INTO `test`.`t`(`id`, `c`, `d`) VALUES (15, 15, 15);
INSERT INTO `test`.`t`(`id`, `c`, `d`) VALUES (20, 20, 20);
INSERT INTO `test`.`t`(`id`, `c`, `d`) VALUES (25, 25, 25);
```

|      | session A                                                    | session B                                                   |
| ---- | ------------------------------------------------------------ | ----------------------------------------------------------- |
| T1   | begin;<br />select id from t where c=5 lock in share mode;   |                                                             |
| T2   |                                                              | begin;<br />select id from t where c in (20,10) for update; |
| T3   | select id from t where c in (20,10) lock in share mode;      |                                                             |
| T4   |                                                              | select id from t where c = 5 for update;                    |
| T5   | ERROR 1213 (40001): Deadlock found when trying to get lock; try restarting transaction |                                                             |

![image-20191205111102458](https://note.youdao.com/yws/public/resource/4762addbbb207565dafe6a1264ea04a1/xmlnote/WEBRESOURCE6b54e7dfa40f247f91b67ce9b9bd6053/8734)

1. 通过show engine innodb status查看latest detected deadlock信息

2. 事物1

   - 语句select id from t where c in (20,10) lock in share mode;
   - wating for this lock to be granted:等待的锁
   - 锁类型:record locks 使用索引 index:c 表:test.t lock mode s waiting recore lock:等待读锁,锁类型为行锁
   - n_fields 2:字段两个即 (c,id)字段
   - 0: len 4; hex 8000000a;asc   ;;1:....... 代表等待是(10,10)的行锁

3. 事物2

   - select id from t where c in (5) for update
   - Holds the lock(s):获取到的共享锁,由于之前的 c in (20,10) for update 获取了20,10的行锁
   - 锁类型:行锁  index:c table:test.t lock_mode x record lock:获取了排它锁类型行锁
   - n_fields 2:代表字段两个(c,id)   第一行:(10,10) (20,20)  a十六进制转10进制:10 14十六进制转十进制:20
   - waiting for this lock to be granted:等待的锁
   - 行锁类型 lock_mode x waiting record lock:排它锁 行锁 等待行锁为:(5,5)
   - 此时出现死锁:session A:获取了 (5,5)行锁,等待(20,20) (10,10)行锁,sessionB:获取了(20,10)行锁,等待获取(5,5)行锁

4. sql优化为并发下

   ```sql
   select id from t where c in (5,20,10) lock in share mode;
   select id from t where c in (5,20,10) order by c desc for update;
   ```

## 案例二

|      | session A                                                    | session B                               |
| ---- | ------------------------------------------------------------ | --------------------------------------- |
| T1   | begin;<br />select * from t where id > 10 and id<=15 for update; |                                         |
| T2   |                                                              | Delete from t where id=10;              |
| T3   |                                                              | insert into t values(10,10,10) blocking |

1. session A T1时候获取锁,(10,15] (15,20],找到第一个满足条件的值id=15,由于存在bug,主键范围查询需要向右继续扫描到下一个不相等的即id=20

2. 当session B T2时候删除id=10行记录时,扫描到id=10,获取(5,10]next-key,由于主键等值查询,获取id=10行锁,删除数据,此时数据库间隙变为 (-无穷,1) (1,5) (5,15) (15,20)......

3. 由于session A T1时候获取的间隙锁(10,15)右节点为15,10被删除后区间变为(5,15)间隙锁

4. session B T3时候插入数据阻塞

5. show engine innodb status

   ![image-20191205140811083](https://note.youdao.com/yws/public/resource/4762addbbb207565dafe6a1264ea04a1/xmlnote/WEBRESOURCEeb768d529155903ccde744a5f9dfd296/8736)

- index primary:主键id  表:test.t
- lock mode x locks gap before rec insert intention wating
- gap before rec:表示这是一个间隙锁 insert intention:表示当前线程在准备一个插入操作,使用的是插入意向锁
- n_fields 5:代表记录了5列
  1. 第一列:id  0f:15 因为id=10不存在,则间隙为(5,15)
  2. 第二列:长度为6的事物id   trx_id:607779
  3. 第三列:长度为7的回滚段
  4. 第四列和第五列即字段c,d (15,15)
- 结论:所谓的间隙,间隙是由右边的值确定的

