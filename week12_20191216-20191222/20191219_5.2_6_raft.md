## 服务状态变化

![image-20191222105743566](https://note.youdao.com/yws/public/resource/4762addbbb207565dafe6a1264ea04a1/xmlnote/9ACC4F7C308C484FB362D681EF6457BB/8860)

1. 三台机器同时启动后,此时集群中机器都为follower,当其中一台随机事件超时后变为cd
2. 变为cd,term+1,重置选举时间,给其他flw发送选举投票
3. 大多数节点投票通过后变为ld
4. 当ld宕机后其他节点变为ld时,他自己重启的时候如果收到ld的rpc请求降级自己为flw
5. 同时如果在节点为cd是,发送投票请求时发现别人term要更大此时将自己变为flw
6. cd选举过程中如果投票超时(比如两个cd同票),继续执行cd选举

## 选举

1. 每个服务对同一个任期的候选人投票只会投给其中一个,先来先服务的原则
2. 候选人在选举的过程中可能收到别人是ld发送过来的空的附加rpc信息,如果此时term大于自己则直接变为flw,否则返回自己的term让ld去更新
3. 候选人选举超时,开始下一轮选举,term+1,重置时间,发送选举rpc请求
4. 选举时间是一个固定的随机时间(150-300ms)

## 日志复制

![image-20191222111102627](https://note.youdao.com/yws/public/resource/4762addbbb207565dafe6a1264ea04a1/xmlnote/B4F26553D90D4C3185C1AE1CA5EAAE55/8862)

1. 当ld给flw发送rpc附加请求是flw的日志情况可能是下面4种
2. 对于不同的日志中两个log中有相同的index是term相同,则他们存储的相同指定
3. index相同term相同时,在这个index之前的节点信息是相同的
4. 大多数节点存在N时commitIndex更新为N即第五个节点

![image-20191222111823522](https://note.youdao.com/yws/public/resource/4762addbbb207565dafe6a1264ea04a1/xmlnote/BF04ABD040764419AFBE114C08CCBB9F/8864)

1. 当一个节点变为leader时,follower的情况可能是a-f中一种;可能比leader少,也可能多,也可能在某个index数据不一致
2. a,b:flw中数据比ld少 可能日志数据未复制
3. c:flw中数据比ld多,说明ld中数据并不是最全的
4. d:存在比ld大的term的数据,可能是上一个ld当前时未提交的数据
5. e:服务是任期4时是ld,写入了index67的数据但是在还未提交的时候宕机了
6. f:服务在任期2时是ld,写入4,5,6的数据在未提交的时候宕机了,然后在任期3的时候又被选为了ld,然后写入一部分数据还未提交又宕机了

## 安全性

1. 任何任期的ld都会拥有之前任期被已提交的日志条目

![image-20191222113233290](https://note.youdao.com/yws/public/resource/4762addbbb207565dafe6a1264ea04a1/xmlnote/21F7CB94F187478F9B09C2719F0554E3/8866)

1. 某个log在大多数节点被复制后并不一定一定会存在,比如上图中index:2 term:2的数据,被复制到s2后宕机s5称为ld,之后s5宕机s1term:4成为新的ld,同时给s3复制2的数据复制完后宕机.如果此时s1宕机s5可以重新选为ld将s1:index2的数据覆盖为3.同时如果s1不宕机复制给大多数节点2,4之后满足n后提交数据

## 时间和可用性

```tex
广播时间(broadcastTime) << 选举超时时间(electionTimeout) << 平均故障间隔时间(MTBF)
广播时间:指ld给flw发送rpcs请求时flw平均的响应时间
选举超时时间:固定的随机时间150-300ms,随机好处:当多个cd同票时选举先超时的重置选举和term+1后可以变为ld
平均故障间隔时间:两次故障之间的平均时间
第一个小于:这样领导人才能给flw发送稳定的心跳,防止flw来进行选举
第二个小于:因为当选举超时的时候整个系统是不可用的,所以要小于平均的故障间隔时间
```

