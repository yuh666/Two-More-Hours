## 所有服务器参数

| 状态        | 所有服务器上持久存在的                                       |
| ----------- | ------------------------------------------------------------ |
| currentTerm | 当前服务的任期号(初始值为0)                                  |
| votedFor    | 当前该服务跟随的leader或投票的candidater                     |
| log[]       | 日志条目集;每一个log对应多个entry[] 每个entry中包含index+term+command |

| 状态        | 所有服务器经常变的                                           |
| ----------- | ------------------------------------------------------------ |
| commitIndex | 当前服务器已提交的日志条目对应的索引值                       |
| lastApplied | 最后被应用到状态机的日志条目索引值(如果当前日志提交了还没应用到状态机此时commitIndex>lastApplied,应该让lastApplied=commitIndex) |

| 状态         | 在领导人里经常改变的(选举后重新初始化)                       |
| ------------ | ------------------------------------------------------------ |
| nextIndex[]  | 维护需要发送给其他服务的下一个日志条目对应的索引值(初始化:领导人最后索引值+1) |
| matchIndex[] | 维护已复制给其他服务的日志的最高索引值(用来判断是否大多数复制完成进行commit操作) |



## leader rpc

1. leader给其他follower发送的附加日志rpc,leader给follower心跳或日志复制
2. 以后ld代表leader,flw:follower  cd:candidater

| 参数         | 解释                                                         |
| ------------ | ------------------------------------------------------------ |
| term         | 领导人的任期号                                               |
| leaderId     | 领导人的id,用来flw重定向                                     |
| prevLogIndex | 新log对应的index                                             |
| prevLogTerm  | 新log对应的term                                              |
| entries[]    | 如果是复制即日志条目(发送多个提交效率,让flw更快的复制),心跳则为空 |
| leaderCommit | ld已提交日志的索引值                                         |

| 返回值  | 解释                                      |
| ------- | ----------------------------------------- |
| term    | 当前flw的任期号                           |
| success | 根据包含ld中新的日志index和term时返回true |

1. term < currentTerm 返回false

2. 发送日志的index的term和term不匹配,返回false;flw中数据与ld不匹配,比如ld:index=2的地方term=1 flw:index=2的地方 term=2  此时ld应该先找到能和flw匹配的index位置

3. flw中如果存在index相同term不同的时候,需要删除flw相同节点之后饿所有数据

4. 发送过来的日志条目未存在最新的

5. leaderCommit > commitIndex,当ld的commit的索引值大于flw的索引值时此时commitIndex=min(leaderCommitIndex,logIndex);可能存在flw中日志还未复制到leadercommitIndex的情况

   

## candidater election

| 参数         | 解释                   |
| ------------ | ---------------------- |
| term         | 候选人的任期号         |
| candidateId  | 候选人的id             |
| lastLogIndex | 候选人最后条目的索引值 |
| lastLogTerm  | 候选人最后条件的任期号 |

| 返回值      | 解释                                                 |
| ----------- | ---------------------------------------------------- |
| term        | 当前flw或者cd的任期号,比如投票失败cd来更新自己的term |
| voteGranted | 当候选人赢的投票时为true                             |

1. 比较currentTerm > term,返回false
2. 如果当前flw中votedFor为空,即没给任何人投票或者为当前cd的id,并且cd的日志和自己一样新或者比自己还要新则投票给这个cd

## 所有服务都遵守的

1. 所有服务器
   - 当commitIndex>lastApplied时,需要将lastApplied更新到commitIndex,然后将log[lastApplied]更新到状态机中;保证自己commit后的数据都应用到状态机上,防止commit成功了更新过程宕机了进行数据的恢复
   - 如果接受的rpc请求或响应中,任期号T>currentTerm,则更新自己的term为别人;同时自己降为flw
2. 跟随者
   - 响应领导人的rpc请求和候选人的投票请求
   - 当flw中随机时间到了后还没收到ld的rpc请求或者cd的投票请求,自己变为cd
3. 候选人
   - 变为候选人就开始投票选举过程
     - 自增任期号term+1
     - 给自己投票即votedFor自己
     - 重置选举时间(比如选举票数相同后选举超时需要重置)
     - 发送请求投票的rpc请求给其他服务器(包括flw和cd)
   - 接收到大部分的人的投票,将自己变为ld
   - 接收到新的ld的附件空的rpc请求,将自己变为flw同时更新自己的term和votedFor为 ld
   - 如果选举超时再次发起一次选举,比如多个cd之间同票
4. 领导人
   - 发送空的附加日志rpc(心跳)给其他服务器;防止其他服务器随机时间超时
   - 接收客户端的所有请求,附加到本地日志然后在发送rpc给flw大多数响应后标记为commit然后响应客户端commit
   - 给flw发送rpc请求时,要根据flw返回的信息来调整nextIndex找到flw中在ld中最接近的index后将之后的数据发给flw,发送完后同时更新改flw对应的nextIndex和matchIndex
   - 如果存在一个N>commitIndex,同时大多数mathIndex[i]>=N成立,并且log[N].term=currentTerm,则提交commitIndex=N;即ld未提交的日志条目在大多数flw中存在,此时进行commit并更新ld的commitIndex

## 总结

| 特性             | 解释                                                         |
| ---------------- | ------------------------------------------------------------ |
| 选举安全特性     | 指定任期号只会有一个leader                                   |
| 领导人只附件原则 | 领导人中的日志绝对不会删除或覆盖,所有操作都是追加到日志中    |
| 日志匹配原则     | 如果某个日志节点的index和term都相同,则在该节点之前的日志条目也是相同 |
| 领导人完全特性   | 如果某个日志在某个任期中被提交,则这个日志会出现在更大的任期中 |
| 状态机安全特性   | 如果领导人的某个指定索引位置的数据应用到状态机,其他服务器在该索引位置不会提交不同的日志; |

