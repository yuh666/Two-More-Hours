## 快照

1. 快照作用:防止有的flw或新加入是落后ld太多,需要ld尝试发送多次rpc才能找到对应的点

2. 通过快照的方式将日志进行压缩

   ![img](https://note.youdao.com/yws/public/resource/4762addbbb207565dafe6a1264ea04a1/xmlnote/34EF1DBBF9B2415D94B30447CF784410/8868)

3. last included index:指快照最后对应的索引下标值即 x:0  index:5 term:3 同理last included term

4. 状态机的值:x->0 y->9  记录x和y的最新值

| 参数              | 解释                              |
| ----------------- | --------------------------------- |
| term              | 领导人的任期号                    |
| leaderId          | 领导人的id,以便跟随者的重定向请求 |
| lastIncludedIndex | 快照中包含的最后日志条目的索引值  |
| lastIncludedTerm  | 快早中最后日志条目的任期号        |
| offset            | 分块在快照中的字节偏移量          |
| data[]            | 原始数据                          |
| done              | 如果这是最后一个分块则为true      |

| 结果 | 解释                          |
| ---- | ----------------------------- |
| term | 当前任期号,以便领导人更新自己 |

1. 如果term < currentTerm,立即回复
2. offset=0,代表第一个分块则直接创建一个快照
3. 否则根据指定偏移量来写入数据
4. 如果done不为true,则说明不是最后一块则继续等待
5. 保存快照,同时丢弃有较小索引的快照或者部分快照
6. 如果现有的日志条目与快照中最后包含的日志条目具有相同的index和term,则只用保留其后的日志条目并进行恢复
7. 如果数据和快照中完全相同的话直接丢弃整个日志
8. 使用快照重置状态机并加载集群的配置

## 客户端交换

1. 服务端的接口保证幂等,客户端给服务端的每一个指令都有一个唯一的序列号,服务端会先判断当前命令是否被执行过执行过则直接返回数据.
2. 所有的请求都走服务端的ld,当随机选择服务器为flw时flw会拒绝然后返回ld的信息给客户端来连接